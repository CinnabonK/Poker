<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポーカーゲーム</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
            text-align: center;
        }

        #player-form {
            margin-bottom: 20px;
        }

        .player-list {
            margin: 20px 0;
            font-size: 18px;
        }

        .player-area {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
            border-radius: 50%;
            border: 2px solid white;
        }

        .player {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: #34495e;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .player-name {
            font-size: 14px;
        }

        .chips {
            font-size: 12px;
        }

        #dealer-cards {
            margin: 20px 0;
            font-size: 24px;
        }

        #pot {
            margin-top: 20px;
            font-size: 24px;
            background-color: #e74c3c;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
        }

        .action-buttons {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #3498db;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }

        #next-player {
            font-size: 20px;
            margin-top: 30px;
        }

        .winner-screen, .lobby-screen {
            display: none;
        }

        .winner-screen h2, .lobby-screen h2 {
            font-size: 36px;
            color: #2ecc71;
        }

        .winner-screen button, .lobby-screen button {
            background-color: #27ae60;
        }

        /* シーン切り替え用のスタイル */
        #card-check-scene, #poker-table-scene, #winner-screen, #lobby-screen {
            display: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <h1>ポーカーゲーム</h1>

    <!-- ロビーシーン -->
    <div id="lobby-screen" class="lobby-screen">
        <h2>ロビー</h2>
        <div id="player-list" class="player-list">参加者名：</div>
        <div id="player-form">
            <label for="player-name">プレイヤー名を入力してください：</label>
            <input type="text" id="player-name">
            <button onclick="addPlayer()">追加</button>
            <button onclick="removePlayer()">削除</button>
            <button onclick="startGame()">ゲーム開始</button>
        </div>
    </div>

    <!-- 手札確認シーン -->
    <div id="card-check-scene" class="hidden">
        <div id="pass-message">次のプレイヤー名さんに端末を渡してください</div>
        <button onclick="showCards()">OK</button>
        <div id="player-cards" style="display: none;"></div>
        <button onclick="nextPlayerForCardCheck()" id="memorized-button" style="display: none;">覚えた</button>
    </div>

    <!-- ポーカーテーブルシーン -->
    <div id="poker-table-scene" class="hidden">
        <!-- プレイヤー表示エリア -->
        <div class="player-area" id="players"></div>

        <!-- ディーラーがめくったカード -->
        <div id="dealer-cards">ディーラーのカード: </div>

        <!-- ポット -->
        <div id="pot">ポット: 0コイン</div>

        <!-- BETフィールド -->
        <div>
            <input type="number" id="bet-amount" placeholder="ベット額を入力">
        </div>

        <!-- 行動ボタン -->
        <div class="action-buttons">
            <button onclick="bet()">BET</button>
            <button onclick="call()">CALL</button>
            <button onclick="fold()">FOLD</button>
            <button onclick="check()" id="check-button">CHECK</button>
        </div>

        <!-- 次のプレイヤー -->
        <div id="next-player"></div>
    </div>

    <!-- 勝利画面 -->
    <div id="winner-screen" class="hidden">
        <h2>勝者: <span id="winner-name"></span></h2>
        <p id="winner-chips"></p>
        <p id="winner-hand"></p>
        <div id="all-players-hands"></div>
        <button onclick="returnToLobby()">ロビーに戻る</button>
    </div>

    <script>
        const players = [];
        let currentPlayerIndex = 0;
        let pot = 0;
        let tableCards = [];
        let round = 1; // ラウンドトラッキング（1巡目はカード2枚）
        let isGameStarted = false;
        let previousBet = 0; // 前のプレイヤーのベット額を保持
        let activePlayers = []; // 現在アクティブなプレイヤー

        // プレイヤー追加
        function addPlayer() {
            const name = document.getElementById("player-name").value;
            if (name && players.length < 8) {
                players.push({ name: name, chips: 1000, cards: [], isFolded: false });
                document.getElementById("player-name").value = '';
                updatePlayerList();
                updatePlayersUI();
            } else {
                alert("プレイヤー名を入力してください。または、プレイヤーは8人までです。");
            }
        }

        // プレイヤー削除
        function removePlayer() {
            const name = document.getElementById("player-name").value;
            const index = players.findIndex(player => player.name === name);
            if (index > -1) {
                players.splice(index, 1);
                document.getElementById("player-name").value = '';
                updatePlayerList();
                updatePlayersUI();
            }
        }

        // プレイヤーリスト表示
        function updatePlayerList() {
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '参加者名：' + players.map(player => player.name).join(', ');
        }

        // プレイヤーエリアのUIを更新
        function updatePlayersUI() {
            const playerArea = document.getElementById('players');
            playerArea.innerHTML = '';
            const n = players.length;
            const centerX = 250;
            const centerY = 250;
            const radius = 200;
            
            players.forEach((player, index) => {
                const angle = (index * (360 / n)) * (Math.PI / 180);
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                const playerDiv = document.createElement('div');
                playerDiv.classList.add('player');
                playerDiv.style.left = `${x - 50}px`; // 中心からのずれを調整
                playerDiv.style.top = `${y - 50}px`;  // 中心からのずれを調整
                playerDiv.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div class="chips" id="chips-${player.name}">${player.chips}コイン</div>
                `;
                playerArea.appendChild(playerDiv);
            });
        }

        // ゲーム開始
        function startGame() {
            if (players.length < 3) {
                alert("プレイヤーは3人以上必要です。");
                return;
            }
            isGameStarted = true;
            activePlayers = players.filter(player => player.chips > 0);
            payTableFee(); // ゲーム開始時に場代を払わせる
            document.getElementById('lobby-screen').classList.add('hidden');  // ロビーを非表示
            showCardCheckScene();  // 手札確認シーンの表示
        }

        // プレイヤーが場代を払う処理
        function payTableFee() {
            activePlayers.forEach(player => {
                if (player.chips > 0) {
                    if (player.chips <= 50) {
                        alert(`${player.name}は残高が少ないためALL INします！`);
                        pot += player.chips;
                        player.chips = 0;
                    } else {
                        player.chips -= 50;
                        pot += 50;
                    }
                    updatePlayerChips(player);
                }
            });
            updatePot();
        }

        // 手札確認シーンを表示
        function showCardCheckScene() {
            document.getElementById('card-check-scene').classList.remove('hidden');
            document.getElementById('poker-table-scene').classList.add('hidden');  // ポーカーテーブルを非表示
            document.getElementById('pass-message').innerText = `${activePlayers[currentPlayerIndex].name}さんに端末を渡してください`;
        }

        // プレイヤーの手札を表示
        function showCards() {
            document.getElementById('player-cards').innerText = `手札: ${generateRandomCards()}`;
            document.getElementById('player-cards').style.display = 'block';
            document.getElementById('memorized-button').style.display = 'inline-block';  // 覚えたボタンを表示
        }

        // 次のプレイヤーへ手札確認
        function nextPlayerForCardCheck() {
            document.getElementById('player-cards').style.display = 'none';
            document.getElementById('memorized-button').style.display = 'none';

            currentPlayerIndex++;
            if (currentPlayerIndex < activePlayers.length) {
                showCardCheckScene();
            } else {
                document.getElementById('card-check-scene').classList.add('hidden');  // 手札確認シーンを非表示
                document.getElementById('poker-table-scene').classList.remove('hidden');  // ポーカーテーブルシーンを表示
                currentPlayerIndex = 0;  // プレイヤーターンをリセット
                dealInitialCards();
                startPlayerTurn();
            }
        }

        // ディーラーが最初に2枚カードをめくる
        function dealInitialCards() {
            tableCards = ['♠️A', '♦️K']; // カード例（本来はランダムに生成）
            document.getElementById('dealer-cards').innerText = `ディーラーのカード: ${tableCards.join(', ')}`;
        }

        // ランダムなカードを生成
        function generateRandomCards() {
            const suits = ['♠️', '♦️', '♣️', '♥️'];
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const cards = [];

            for (let i = 0; i < 2; i++) {
                const suit = suits[Math.floor(Math.random() * suits.length)];
                const rank = ranks[Math.floor(Math.random() * ranks.length)];
                cards.push(`${suit}${rank}`);
            }

            return cards.join(', ');
        }

        // プレイヤーのターン開始
        function startPlayerTurn() {
            const player = activePlayers[currentPlayerIndex];
            if (player.isFolded || player.chips === 0) {
                nextPlayer();
                return;
            }
            document.getElementById('next-player').innerText = `${player.name}のターンです。`;
            checkBettingConditions();
        }

        // ベット条件を確認
        function checkBettingConditions() {
            const player = activePlayers[currentPlayerIndex];
            const canCheck = previousBet === 0;
            document.getElementById('check-button').disabled = !canCheck;
        }

        // BET
        function bet() {
            const player = activePlayers[currentPlayerIndex];
            const betInput = document.getElementById('bet-amount');
            const betAmount = parseInt(betInput.value, 10);

            if (isNaN(betAmount) || betAmount <= 0) {
                alert("有効なベット額を入力してください。");
                return;
            }

            if (betAmount >= player.chips) {
                alert("オールインします！");
                pot += player.chips;
                previousBet = player.chips;
                player.chips = 0;
            } else {
                pot += betAmount;
                previousBet = betAmount;
                player.chips -= betAmount;
            }

            updatePlayerChips(player);
            updatePot();
            nextPlayer();
        }

        // CALL
        function call() {
            const player = activePlayers[currentPlayerIndex];

            if (previousBet > player.chips) {
                pot += player.chips;
                player.chips = 0;
            } else {
                pot += previousBet;
                player.chips -= previousBet;
            }

            updatePlayerChips(player);
            updatePot();
            nextPlayer();
        }

        // FOLD
        function fold() {
            activePlayers[currentPlayerIndex].isFolded = true;
            if (activePlayers.filter(player => !player.isFolded).length === 1) {
                // 全員FOLDした場合、最後の残りのプレイヤーが勝者
                declareWinner(activePlayers.find(player => !player.isFolded), "フォールドにより勝利");
            } else {
                nextPlayer();
            }
        }

        // CHECK
        function check() {
            if (activePlayers.every(player => player.isFolded || player.chips === 0 || previousBet === 0)) {
                // 全員がチェックした場合、新しいカードを追加
                if (tableCards.length < 5) {
                    tableCards.push(generateRandomCards()); // 新しいカードをめくる
                    document.getElementById('dealer-cards').innerText = `ディーラーのカード: ${tableCards.join(', ')}`;
                } else {
                    // すべてのカードが揃った場合、手札をオープン
                    revealHands();
                }
            }
            nextPlayer();
        }

        // 次のプレイヤーへ
        function nextPlayer() {
            do {
                currentPlayerIndex = (currentPlayerIndex + 1) % activePlayers.length;
            } while (activePlayers[currentPlayerIndex].isFolded || activePlayers[currentPlayerIndex].chips === 0);

            startPlayerTurn();
        }

        // プレイヤーのチップを更新
        function updatePlayerChips(player) {
            document.getElementById(`chips-${player.name}`).innerText = `${player.chips}コイン`;
        }

        // ポットの更新
        function updatePot() {
            document.getElementById('pot').innerText = `ポット: ${pot}コイン`;
        }

        // ゲームの再スタート
        function restartGame() {
            pot = 0;
            currentPlayerIndex = 0;
            round = 1;
            isGameStarted = false;
            previousBet = 0;
            document.getElementById('player-form').style.display = 'block';
            document.getElementById('winner-screen').style.display = 'none';
            updatePlayersUI();
        }

        // 全員の手札をオープンして役判定
        function revealHands() {
            const allHands = activePlayers.map(player => {
                const hand = player.cards.concat(tableCards);
                const rankedHand = rankHands(hand); // 役判定を実行
                return { player, rankedHand };
            });

            allHands.sort((a, b) => b.rankedHand.rank - a.rankedHand.rank); // 役の強さでソート

            declareWinner(allHands[0].player, allHands[0].rankedHand.name);

            const allHandsDisplay = allHands.map(handInfo => {
                return `${handInfo.player.name}: ${handInfo.rankedHand.name}`;
            }).join('<br>');

            document.getElementById('all-players-hands').innerHTML = allHandsDisplay;
        }

        // 勝者を宣言
        function declareWinner(winner, handName) {
            document.getElementById('winner-name').innerText = winner.name;
            document.getElementById('winner-chips').innerText = `獲得チップ: ${pot}`;
            document.getElementById('winner-hand').innerText = `役: ${handName}`;
            document.getElementById('winner-screen').classList.remove('hidden');
        }

        // ロビーに戻る
        function returnToLobby() {
            document.getElementById('winner-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            restartGame();
        }

        // 役判定関数（ロイヤルフラッシュ、ストレートフラッシュ等を含む）
        function rankHands(cards) {
            const hand = cards.map(card => {
                const value = card.slice(1);
                return { suit: card[0], value: isNaN(value) ? convertFaceCard(value) : parseInt(value, 10) };
            });

            hand.sort((a, b) => b.value - a.value); // 値でソート

            // 役判定ロジック
            if (isRoyalFlush(hand)) return { name: 'ロイヤルフラッシュ', rank: 9 };
            if (isStraightFlush(hand)) return { name: 'ストレートフラッシュ', rank: 8 };
            if (isFourOfAKind(hand)) return { name: 'フォーカード', rank: 7 };
            if (isFullHouse(hand)) return { name: 'フルハウス', rank: 6 };
            if (isFlush(hand)) return { name: 'フラッシュ', rank: 5 };
            if (isStraight(hand)) return { name: 'ストレート', rank: 4 };
            if (isThreeOfAKind(hand)) return { name: 'スリーカード', rank: 3 };
            if (isTwoPair(hand)) return { name: 'ツーペア', rank: 2 };
            if (isOnePair(hand)) return { name: 'ワンペア', rank: 1 };

            return { name: '無役', rank: 0 };
        }

        // 顔カード（J, Q, K, A）を数値に変換
        function convertFaceCard(faceCard) {
            switch (faceCard) {
                case 'A': return 14;
                case 'K': return 13;
                case 'Q': return 12;
                case 'J': return 11;
                default: return 0;
            }
        }

        // フラッシュ判定
        function isFlush(hand) {
            return hand.every(card => card.suit === hand[0].suit);
        }

        // ストレート判定
        function isStraight(hand) {
            for (let i = 1; i < hand.length; i++) {
                if (hand[i - 1].value - hand[i].value !== 1) {
                    return false;
                }
            }
            return true;
        }

        // ロイヤルフラッシュ判定
        function isRoyalFlush(hand) {
            return isStraightFlush(hand) && hand[0].value === 14 && hand[4].value === 10;
        }

        // ストレートフラッシュ判定
        function isStraightFlush(hand) {
            return isFlush(hand) && isStraight(hand);
        }

        // フォーカード判定
        function isFourOfAKind(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 4).length === 4;
        }

        // フルハウス判定
        function isFullHouse(hand) {
            const values = hand.map(card => card.value);
            const three = values.filter(val => values.filter(v => v === val).length === 3).length === 3;
            const two = values.filter(val => values.filter(v => v === val).length === 2).length === 2;
            return three && two;
        }

        // スリーカード判定
        function isThreeOfAKind(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 3).length === 3;
        }

        // ツーペア判定
        function isTwoPair(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 2).length === 4;
        }

        // ワンペア判定
        function isOnePair(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 2).length === 2;
        }
    </script>

</body>
</html>
