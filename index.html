<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ポーカーゲーム</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: white;
            text-align: center;
        }

        #player-form {
            margin-bottom: 20px;
        }

        .player-list {
            margin-bottom: 20px;
            color: white;
        }

        .player-area {
            position: relative;
            width: 500px;
            height: 500px;
            margin: 0 auto;
            border-radius: 50%;
            border: 2px solid white;
        }

        .player {
            position: absolute;
            width: 100px;
            height: 100px;
            background-color: #34495e;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .player-name {
            font-size: 14px;
        }

        .chips {
            font-size: 12px;
        }

        #dealer-cards {
            margin: 20px 0;
            font-size: 24px;
        }

        #pot {
            margin-top: 20px;
            font-size: 24px;
            background-color: #e74c3c;
            padding: 10px;
            border-radius: 10px;
            display: inline-block;
        }

        .action-buttons {
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            margin: 10px;
            background-color: #2980b9;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            background-color: #3498db;
        }

        input[type="number"] {
            padding: 10px;
            font-size: 16px;
            margin: 10px;
        }

        #next-player {
            font-size: 20px;
            margin-top: 30px;
        }

        .winner-screen {
            display: none;
        }

        .winner-screen h2 {
            font-size: 36px;
            color: #2ecc71;
        }

        .winner-screen button {
            background-color: #27ae60;
        }

        /* シーン切り替え用のスタイル */
        #card-check-scene, #poker-table-scene, #lobby-scene {
            display: none;
        }

        /* ロビーでのプレイヤー表示 */
        #lobby-player-list {
            color: white;
        }
    </style>
</head>
<body>

    <h1>ポーカーゲーム</h1>

    <!-- ロビーシーン -->
    <div id="lobby-scene">
        <!-- プレイヤー追加フォーム -->
        <div id="player-form">
            <label for="player-name">プレイヤー名を入力してください：</label>
            <input type="text" id="player-name">
            <button onclick="addPlayer()">追加</button>
            <button onclick="startGame()">ゲーム開始</button>
            <button onclick="removePlayer()">削除</button>
        </div>

        <!-- プレイヤーリスト -->
        <div id="lobby-player-list"></div>
    </div>

    <!-- 手札確認シーン -->
    <div id="card-check-scene">
        <div id="pass-message">次のプレイヤー名さんに端末を渡してください</div>
        <button onclick="showCards()">OK</button>
        <div id="player-cards" style="display: none;"></div>
        <button onclick="nextPlayerForCardCheck()" id="memorized-button" style="display: none;">覚えた</button>
    </div>

    <!-- ポーカーテーブルシーン -->
    <div id="poker-table-scene">
        <!-- プレイヤー表示エリア -->
        <div class="player-area" id="players"></div>

        <!-- ディーラーがめくったカード -->
        <div id="dealer-cards">ディーラーのカード: </div>

        <!-- ポット -->
        <div id="pot">ポット: 0コイン</div>

        <!-- BETフィールド -->
        <div>
            <input type="number" id="bet-amount" placeholder="ベット額を入力">
        </div>

        <!-- 行動ボタン -->
        <div class="action-buttons">
            <button onclick="bet()">BET</button>
            <button onclick="call()">CALL</button>
            <button onclick="fold()">FOLD</button>
            <button onclick="check()" id="check-button">CHECK</button>
        </div>

        <!-- 次のプレイヤー -->
        <div id="next-player"></div>
    </div>

    <!-- 勝利画面 -->
    <div id="winner-screen" class="winner-screen">
        <h2>勝者: <span id="winner-name"></span></h2>
        <p id="winner-chips"></p>
        <p id="winner-hand"></p>
        <div id="all-hands"></div>
        <button onclick="returnToLobby()">ロビーに戻る</button>
    </div>

    <script>
        const players = [];
        let currentPlayerIndex = 0;
        let pot = 0;
        let tableCards = [];
        let round = 1; // ラウンドトラッキング（1巡目はカード2枚）
        let isGameStarted = false;
        let previousBet = 0; // 前のプレイヤーのベット額を保持
        let activePlayers = []; // 現在アクティブなプレイヤー

        function addPlayer() {
            if (players.length >= 8) {
                alert("プレイヤーは8人までです。");
                return;
            }

            const name = document.getElementById("player-name").value;
            if (name) {
                players.push({ name: name, chips: 1000, cards: [], isFolded: false });
                document.getElementById("player-name").value = '';
                updateLobbyPlayerList();
            }
        }

        function removePlayer() {
            const name = document.getElementById("player-name").value;
            const index = players.findIndex(player => player.name === name);
            if (index > -1) {
                players.splice(index, 1);
                document.getElementById("player-name").value = '';
                updateLobbyPlayerList();
            }
        }

        function updateLobbyPlayerList() {
            const playerList = document.getElementById('lobby-player-list');
            playerList.innerHTML = "<h3>参加者リスト:</h3>";
            players.forEach(player => {
                playerList.innerHTML += `<p>${player.name}</p>`;
            });
        }

        function startGame() {
            if (players.length < 3) {
                alert("プレイヤーは3人以上必要です。");
                return;
            }
            isGameStarted = true;
            activePlayers = players.filter(player => player.chips > 0);
            document.getElementById('lobby-scene').style.display = 'none';
            showCardCheckScene();  // 手札確認シーンの表示
        }

        function showCardCheckScene() {
            document.getElementById('card-check-scene').style.display = 'block';
            document.getElementById('poker-table-scene').style.display = 'none';  // ポーカーテーブルを非表示
            document.getElementById('pass-message').innerText = `${activePlayers[currentPlayerIndex].name}さんに端末を渡してください`;
        }

        function showCards() {
            document.getElementById('player-cards').innerText = `手札: ${generateRandomCards()}`;
            document.getElementById('player-cards').style.display = 'block';
            document.getElementById('memorized-button').style.display = 'inline-block';  // 覚えたボタンを表示
        }

        function nextPlayerForCardCheck() {
            document.getElementById('player-cards').style.display = 'none';
            document.getElementById('memorized-button').style.display = 'none';

            currentPlayerIndex++;
            if (currentPlayerIndex < activePlayers.length) {
                showCardCheckScene();
            } else {
                document.getElementById('card-check-scene').style.display = 'none';  // 手札確認シーンを非表示
                document.getElementById('poker-table-scene').style.display = 'block';  // ポーカーテーブルシーンを表示
                currentPlayerIndex = 0;  // プレイヤーターンをリセット
                collectAnte();  // 場代徴収
                dealInitialCards();
                startPlayerTurn();
            }
        }

        function collectAnte() {
            activePlayers.forEach(player => {
                if (player.chips < 50 && player.chips > 0) {
                    pot += player.chips;  // ALL IN
                    player.chips = 0;
                } else if (player.chips >= 50) {
                    pot += 50;
                    player.chips -= 50;
                }
            });
            updatePot();
            updatePlayersUI();
        }

        function dealInitialCards() {
            // ディーラーが最初に2枚カードをめくる
            tableCards = ['♠️A', '♦️K']; // カード例（本来はランダムに生成）
            document.getElementById('dealer-cards').innerText = `ディーラーのカード: ${tableCards.join(', ')}`;
        }

        function generateRandomCards() {
            const suits = ['♠️', '♦️', '♣️', '♥️'];
            const ranks = ['2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K', 'A'];
            const cards = [];

            for (let i = 0; i < 2; i++) {
                const suit = suits[Math.floor(Math.random() * suits.length)];
                const rank = ranks[Math.floor(Math.random() * ranks.length)];
                cards.push(`${suit}${rank}`);
            }

            return cards.join(', ');
        }

        function startPlayerTurn() {
            const player = activePlayers[currentPlayerIndex];
            if (player.isFolded || player.chips === 0) {
                nextPlayer();
                return;
            }
            document.getElementById('next-player').innerText = `${player.name}のターンです。`;
            checkBettingConditions();
        }

        function checkBettingConditions() {
            const player = activePlayers[currentPlayerIndex];
            const canCheck = previousBet === 0;
            document.getElementById('check-button').disabled = !canCheck;
        }

        function bet() {
            const player = activePlayers[currentPlayerIndex];
            const betInput = document.getElementById('bet-amount');
            const betAmount = parseInt(betInput.value, 10);

            if (isNaN(betAmount) || betAmount <= 0) {
                alert("有効なベット額を入力してください。");
                return;
            }

            if (betAmount >= player.chips) {
                alert("オールインします！");
                pot += player.chips;
                previousBet = player.chips;
                player.chips = 0;
            } else {
                pot += betAmount;
                previousBet = betAmount;
                player.chips -= betAmount;
            }

            updatePlayerChips(player);
            updatePot();
            nextPlayer();
        }

        function call() {
            const player = activePlayers[currentPlayerIndex];

            if (previousBet > player.chips) {
                pot += player.chips;
                player.chips = 0;
            } else {
                pot += previousBet;
                player.chips -= previousBet;
            }

            updatePlayerChips(player);
            updatePot();
            nextPlayer();
        }

        function fold() {
            activePlayers[currentPlayerIndex].isFolded = true;
            if (activePlayers.filter(player => !player.isFolded).length === 1) {
                // 全員FOLDした場合、最後の残りのプレイヤーが勝者
                declareWinner(activePlayers.find(player => !player.isFolded), "フォールドにより勝利");
            } else {
                nextPlayer();
            }
        }

        function check() {
            const remainingPlayers = activePlayers.filter(player => !player.isFolded && player.chips > 0);
            if (remainingPlayers.every(player => player.chips === 0 || previousBet === 0)) {
                if (tableCards.length < 5) {
                    tableCards.push(generateRandomCards()); // 新しいカードをめくる
                    document.getElementById('dealer-cards').innerText = `ディーラーのカード: ${tableCards.join(', ')}`;
                } else {
                    // 全員の手札を公開して勝者を判定する
                    revealHandsAndDetermineWinner();
                }
            }
            nextPlayer();
        }

        function revealHandsAndDetermineWinner() {
            const handsContainer = document.getElementById('all-hands');
            handsContainer.innerHTML = "<h3>全員の手札と役</h3>";
            const hands = activePlayers.map(player => {
                const hand = player.cards.concat(tableCards);
                const rankedHand = rankHands(hand);
                handsContainer.innerHTML += `<p>${player.name}: ${rankedHand.name}</p>`;
                return { player, rankedHand };
            });

            const winner = hands.sort((a, b) => b.rankedHand.rank - a.rankedHand.rank)[0];
            declareWinner(winner.player, "役による勝利");
        }

        function nextPlayer() {
            do {
                currentPlayerIndex = (currentPlayerIndex + 1) % activePlayers.length;
            } while (activePlayers[currentPlayerIndex].isFolded || activePlayers[currentPlayerIndex].chips === 0);

            startPlayerTurn();
        }

        function updatePlayerChips(player) {
            document.getElementById(`chips-${player.name}`).innerText = `${player.chips}コイン`;
        }

        function updatePot() {
            document.getElementById('pot').innerText = `ポット: ${pot}コイン`;
        }

        function restartGame() {
            pot = 0;
            currentPlayerIndex = 0;
            round = 1;
            isGameStarted = false;
            previousBet = 0;
            document.getElementById('winner-screen').style.display = 'none';
            document.getElementById('lobby-scene').style.display = 'block';
            updatePlayersUI();
        }

        function returnToLobby() {
            restartGame();
        }

        function declareWinner(winner, reason) {
            const hand = winner.cards.concat(tableCards); // プレイヤーの手札と場のカードを合わせる
            const rankedHand = rankHands(hand); // 役判定を実行
            document.getElementById('winner-name').innerText = `${winner.name} (${reason})`;
            document.getElementById('winner-chips').innerText = `獲得チップ: ${pot}`;
            document.getElementById('winner-hand').innerText = `役: ${rankedHand.name}`;
            document.getElementById('winner-screen').style.display = 'block';
        }

        // 役判定関数（ロイヤルフラッシュ、ストレートフラッシュ等を含む）
        function rankHands(cards) {
            const hand = cards.map(card => {
                const value = card.slice(1);
                return { suit: card[0], value: isNaN(value) ? convertFaceCard(value) : parseInt(value, 10) };
            });

            hand.sort((a, b) => b.value - a.value); // 値でソート

            // 役判定ロジック
            if (isRoyalFlush(hand)) return { name: 'ロイヤルフラッシュ', rank: 9 };
            if (isStraightFlush(hand)) return { name: 'ストレートフラッシュ', rank: 8 };
            if (isFourOfAKind(hand)) return { name: 'フォーカード', rank: 7 };
            if (isFullHouse(hand)) return { name: 'フルハウス', rank: 6 };
            if (isFlush(hand)) return { name: 'フラッシュ', rank: 5 };
            if (isStraight(hand)) return { name: 'ストレート', rank: 4 };
            if (isThreeOfAKind(hand)) return { name: 'スリーカード', rank: 3 };
            if (isTwoPair(hand)) return { name: 'ツーペア', rank: 2 };
            if (isOnePair(hand)) return { name: 'ワンペア', rank: 1 };

            return { name: 'ハイカード', rank: 0 };
        }

        function convertFaceCard(faceCard) {
            switch (faceCard) {
                case 'A': return 14;
                case 'K': return 13;
                case 'Q': return 12;
                case 'J': return 11;
                default: return 0;
            }
        }

        function isFlush(hand) {
            return hand.every(card => card.suit === hand[0].suit);
        }

        function isStraight(hand) {
            for (let i = 1; i < hand.length; i++) {
                if (hand[i - 1].value - hand[i].value !== 1) {
                    return false;
                }
            }
            return true;
        }

        function isRoyalFlush(hand) {
            return isStraightFlush(hand) && hand[0].value === 14 && hand[4].value === 10;
        }

        function isStraightFlush(hand) {
            return isFlush(hand) && isStraight(hand);
        }

        function isFourOfAKind(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 4).length === 4;
        }

        function isFullHouse(hand) {
            const values = hand.map(card => card.value);
            const three = values.filter(val => values.filter(v => v === val).length === 3).length === 3;
            const two = values.filter(val => values.filter(v => v === val).length === 2).length === 2;
            return three && two;
        }

        function isThreeOfAKind(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 3).length === 3;
        }

        function isTwoPair(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 2).length === 4;
        }

        function isOnePair(hand) {
            const values = hand.map(card => card.value);
            return values.filter(val => values.filter(v => v === val).length === 2).length === 2;
        }
    </script>

</body>
</html>
